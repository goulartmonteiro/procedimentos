<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Busca em Tabela da Rede Contratada</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script> 
    <style>
        body { 
            font-family: sans-serif; 
            margin: 20px; 
            font-size: 16px; 
            line-height: 1.6;
        }
        h1 {
            font-size: 26px; 
            margin-bottom: 25px; 
            color: #333;
        }
        h2 {
            font-size: 20px;
            margin-top: 30px;
            margin-bottom: 15px;
            color: #555;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        .loading-status {
            font-size: 1.1em;
            color: #007bff;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .loading-status.error {
            color: #dc3545;
        }
        .search-area {
            border: 1px solid #ccc; 
            padding: 20px; 
            margin-top: 30px; 
            border-radius: 8px; 
            background-color: #f9f9f9;
        }
        .search-area h3 {
            margin-top: 0;
            color: #444;
            font-size: 18px;
            margin-bottom: 15px;
        }
        .search-area div { 
            margin-bottom: 10px; 
            display: flex;
            align-items: center;
        }
        .search-area label {
            min-width: 180px; /* Alinha os labels */
            margin-right: 10px;
            font-weight: bold;
        }
        input[type="text"] {
            flex-grow: 1; /* Faz o input ocupar o espaço restante */
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
        }
        button { 
            padding: 10px 18px; 
            margin-right: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.3s ease;
        }
        button#btn-buscar {
            background-color: #008CBA; /* Azul */
            color: white;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        button#btn-buscar:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        button#btn-limpar {
            background-color: #f44336; /* Vermelho */
            color: white;
            margin-top: 20px;
        }
        hr { 
            margin: 30px 0; 
            border: 0;
            border-top: 1px dashed #ccc;
        }
    </style>
</head>
<body>

    <h1>Busca em Tabela da Rede Contratada</h1>

    <h2>1. Status do Carregamento da Tabela</h2>
    <div id="loading-status" class="loading-status">Carregando tabela da rede contratada do servidor...</div>

    <hr>

    <h2>2. Realizar Busca</h2>
    <p>Digite o Código e/ou Descrição para buscar informações na tabela.</p>

    <div class="search-area">
        <h3>Critérios de Busca e Resultados</h3>
        <div>
            <label for="codigo_input">Buscar por Código:</label>
            <input type="text" id="codigo_input" placeholder="Ex: 30101017">
        </div>
        <div>
            <label for="descricao_input">Buscar por Descrição:</label>
            <input type="text" id="descricao_input" placeholder="Ex: CONSULTA MEDICA">
        </div>
        <hr style="margin: 15px 0; border: 0; border-top: 1px dotted #e0e0e0;">
        <p>Dados Encontrados:</p>
        <div>
            <label for="codigo_output">Código de Procedimento:</label>
            <input type="text" id="codigo_output" readonly>
        </div>
        <div>
            <label for="descricao_output">Descrição:</label>
            <input type="text" id="descricao_output" readonly>
        </div>
        <div>
            <label for="tipo_pacote_output">Tipo Pacote:</label>
            <input type="text" id="tipo_pacote_output" readonly>
        </div>
        <div>
            <label for="valor_output">Valor:</label>
            <input type="text" id="valor_output" readonly>
        </div>
        <div>
            <label for="anestesia_output">Anestesia:</label>
            <input type="text" id="anestesia_output" readonly>
        </div>
        <div>
            <label for="quantidade_permanencia_output">Qtd. Permanência:</label>
            <input type="text" id="quantidade_permanencia_output" readonly>
        </div>
    </div>

    <button id="btn-buscar" disabled>Buscar</button>
    <button id="btn-limpar">Limpar Tudo</button>

    <script>
        let dadosTabela = null; // Armazenará os dados da tabela
        const EXCEL_URL = 'https://gestordeconteudo.ipsemg.mg.gov.br/publico/img/upload/files/Sa%C3%BAde/Tabelas%20e%20Manual%20de%20Normas/Tabela%20da%20Rede%20Contratada%20-%20Atualiza%C3%A7%C3%A3o%2023.04.2025.xlsx';

        // Elementos da interface
        const loadingStatusDiv = document.getElementById('loading-status');
        const codigoInput = document.getElementById('codigo_input');
        const descricaoInput = document.getElementById('descricao_input');
        const codigoOutput = document.getElementById('codigo_output');
        const descricaoOutput = document.getElementById('descricao_output');
        const tipoPacoteOutput = document.getElementById('tipo_pacote_output');
        const valorOutput = document.getElementById('valor_output');
        const anestesiaOutput = document.getElementById('anestesia_output');
        const quantidadePermanenciaOutput = document.getElementById('quantidade_permanencia_output');
        const btnBuscar = document.getElementById('btn-buscar');
        const btnLimpar = document.getElementById('btn-limpar');

        // --- Índices das Colunas ---
        const COL_IDX = {
            CODIGO_PROCEDIMENTO: 0,   // Coluna A
            DESCRICAO: 1,             // Coluna B
            TIPO_PACOTE: 2,           // Coluna C
            VALOR: 9,                 // Coluna J
            ANESTESIA: 10,            // Coluna K
            QUANTIDADE_PERMANENCIA: 11 // Coluna L
        };

        // --- Funções Auxiliares ---

        // Função para normalizar strings para busca (remove espaços, transforma em minúsculas)
        function normalizarStringBusca(str) {
            return String(str || '').replace(/\s/g, '').trim().toLowerCase();
        }
        
        // Função para obter valor da célula, ou string vazia se undefined/null
        function getCellValue(row, index) {
            return String(row[index] || '');
        }

        // --- Carregamento do Arquivo Excel da Web ---

        async function carregarTabelaDaWeb() {
            loadingStatusDiv.textContent = 'Carregando tabela da rede contratada do servidor...';
            loadingStatusDiv.classList.remove('error');
            btnBuscar.disabled = true; // Desabilita o botão de busca enquanto carrega

            try {
                const response = await fetch(EXCEL_URL, { 
                    mode: 'cors', 
                    cache: 'no-cache' 
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}. Detalhes: ${errorText.substring(0, 100)}...`);
                }
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });

                const primeiraPlanilha = workbook.SheetNames[0];
                // header: 1 garante que cada linha é um array de valores
                dadosTabela = XLSX.utils.sheet_to_json(workbook.Sheets[primeiraPlanilha], { header: 1 });
                
                loadingStatusDiv.textContent = `Tabela carregada com sucesso! (${dadosTabela.length -1} registros).`;
                loadingStatusDiv.style.color = '#28a745'; // Verde para sucesso
                btnBuscar.disabled = false; // Habilita o botão de busca após o carregamento
                console.log(`Tabela "${EXCEL_URL}" carregada. ${dadosTabela.length} linhas (incluindo cabeçalho).`);

            } catch (error) {
                console.error("Erro ao carregar ou processar a tabela do Excel:", error);
                loadingStatusDiv.textContent = `Erro ao carregar a tabela: ${error.message}. Verifique o console.`;
                loadingStatusDiv.classList.add('error'); // Adiciona classe para estilização de erro
                btnBuscar.disabled = true; // Mantém o botão de busca desabilitado em caso de erro
                alert(`Não foi possível carregar a tabela do Excel: ${error.message}. Verifique a URL ou sua conexão.`);
            }
        }

        // --- Função de Busca ---

        function buscarNaTabela(termoCodigo, termoDescricao) {
            let resultado = null;
            const codigoNormalizadoBusca = normalizarStringBusca(termoCodigo);
            const descricaoNormalizadaBusca = normalizarStringBusca(termoDescricao);

            if (!dadosTabela) {
                console.warn("Dados da tabela não carregados. Não é possível realizar a busca.");
                alert("A tabela de dados não foi carregada. Por favor, recarregue a página.");
                return null;
            }

            // Inicia do índice 1 para pular o cabeçalho
            for (let i = 1; i < dadosTabela.length; i++) {
                const row = dadosTabela[i];
                // Garantir que a célula exista antes de tentar acessá-la
                const codigoNaLinha = normalizarStringBusca(getCellValue(row, COL_IDX.CODIGO_PROCEDIMENTO));
                const descricaoNaLinha = normalizarStringBusca(getCellValue(row, COL_IDX.DESCRICAO));

                // A busca pode ser por código EXATO ou descrição que INCLUA o termo
                const codigoMatch = (codigoNormalizadoBusca === '') || (codigoNaLinha === codigoNormalizadoBusca);
                // Usamos includes para descrição, permitindo busca parcial
                const descricaoMatch = (descricaoNormalizadaBusca === '' || descricaoNaLinha.includes(descricaoNormalizadaBusca));

                // Se ambos os termos de busca estiverem vazios, não há critério, então não há match válido
                if (termoCodigo === '' && termoDescricao === '') {
                    continue; 
                }

                if (codigoMatch && descricaoMatch) {
                    resultado = row;
                    break;
                }
            }
            return resultado;
        }

        // --- Funções de Preenchimento e Limpeza de Campos ---

        function preencherCampos(linha) {
            if (linha) {
                codigoOutput.value = getCellValue(linha, COL_IDX.CODIGO_PROCEDIMENTO);
                descricaoOutput.value = getCellValue(linha, COL_IDX.DESCRICAO);
                tipoPacoteOutput.value = getCellValue(linha, COL_IDX.TIPO_PACOTE);
                valorOutput.value = getCellValue(linha, COL_IDX.VALOR);
                anestesiaOutput.value = getCellValue(linha, COL_IDX.ANESTESIA);
                quantidadePermanenciaOutput.value = getCellValue(linha, COL_IDX.QUANTIDADE_PERMANENCIA);
            } else {
                limparCamposOutput();
            }
        }

        function limparCamposOutput() {
            codigoOutput.value = '';
            descricaoOutput.value = '';
            tipoPacoteOutput.value = '';
            valorOutput.value = '';
            anestesiaOutput.value = '';
            quantidadePermanenciaOutput.value = '';
        }

        function limparCamposBusca() {
            codigoInput.value = '';
            descricaoInput.value = '';
        }

        // --- Event Listeners ---

        btnBuscar.addEventListener('click', function() {
            console.log('[Buscar] Botão de busca clicado.');
            if (!dadosTabela) {
                alert("A tabela de dados ainda não foi carregada. Por favor, aguarde ou recarregue a página.");
                return;
            }

            const termoCodigo = codigoInput.value;
            const termoDescricao = descricaoInput.value;

            limparCamposOutput(); // Limpa resultados anteriores

            if (termoCodigo === '' && termoDescricao === '') {
                alert('Por favor, digite um Código ou Descrição para realizar a busca.');
                return;
            }

            const resultado = buscarNaTabela(termoCodigo, termoDescricao);
            preencherCampos(resultado);

            if (resultado) {
                alert('Registro encontrado!');
            } else {
                alert('Nenhum registro encontrado com os critérios fornecidos.');
            }
        });

        btnLimpar.addEventListener('click', function() {
            console.log('[LimparTudo] Limpando todos os campos e resultados.');
            limparCamposBusca();
            limparCamposOutput();
            alert('Todos os campos de busca e resultados foram limpos.');
        });

        // Ativação da Busca ao Pressionar Enter nos campos de Input
        codigoInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') { 
                e.preventDefault(); 
                btnBuscar.click(); 
            } 
        });
        descricaoInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') { 
                e.preventDefault(); 
                btnBuscar.click(); 
            } 
        });

        // --- Carregar a tabela automaticamente ao carregar a página ---
        document.addEventListener('DOMContentLoaded', carregarTabelaDaWeb);

        // Estado inicial do botão
        btnBuscar.disabled = true;
    </script>
</body>
</html>